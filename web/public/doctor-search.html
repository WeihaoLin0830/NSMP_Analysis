<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√∫squeda de Pacientes - NSMP Analysis</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/calculator.css">
    <link rel="stylesheet" href="css/chatbox.css">
    <style>
        .search-container {
            max-width: 600px;
            margin: 2rem auto;
        }
        
        .search-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .search-box input {
            flex: 1;
            padding: 1rem 1.5rem;
            border: 2px solid #e8d5de;
            border-radius: 15px;
            font-size: 1.1rem;
            transition: all 0.2s ease;
        }
        
        .search-box input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(212, 134, 154, 0.15);
        }
        
        .patient-list {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .patient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .patient-item:hover {
            background: #fef9fa;
        }
        
        .patient-item:last-child {
            border-bottom: none;
        }
        
        .patient-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .patient-id {
            font-weight: 600;
            color: var(--primary);
        }
        
        .patient-details {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .patient-cluster {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .patient-cluster.cluster-1 {
            background: #d4edda;
            color: #155724;
        }
        
        .patient-cluster.cluster-2 {
            background: #fff3cd;
            color: #856404;
        }
        
        .no-results {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-card .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-logo">
                <img src="cinta_purpura.png" alt="Logo" class="nav-logo-img">
                NSMP Analysis
            </a>
            <ul class="nav-links">
                <li><a href="/">Inicio</a></li>
                <li><a href="/dashboard">Dashboard</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <section class="form-section">
            <div class="form-header">
                <h1>üë©‚Äç‚öïÔ∏è B√∫squeda de Pacientes</h1>
                <p>Busque pacientes por su √≠ndice para ver su perfil de riesgo y an√°lisis de supervivencia</p>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Buscar por √≠ndice de paciente (ej: 0, 1, 2...)"
                        autofocus
                    >
                    <button class="btn btn-primary" onclick="searchPatient()">
                        üîç Buscar
                    </button>
                </div>

                <!-- Stats Summary -->
                <div class="stats-summary" id="statsSummary">
                    <div class="stat-card">
                        <div class="stat-value" id="totalPatients">-</div>
                        <div class="stat-label">Total Pacientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="cluster1Count">-</div>
                        <div class="stat-label">Cluster 1</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="cluster2Count">-</div>
                        <div class="stat-label">Cluster 2</div>
                    </div>
                </div>

                <!-- Patient List -->
                <div class="patient-list" id="patientList">
                    <div class="no-results" id="loadingMessage">
                        Cargando lista de pacientes...
                    </div>
                </div>
            </div>
        </section>

        <!-- Result Section (hidden initially) -->
        <section class="result-section" id="resultSection" style="display: none;">
            <!-- Results will be populated by JavaScript -->
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>Desarrollado con üíú para el proyecto BitsxMT25</p>
        <p><small>Panel de profesionales m√©dicos - Datos confidenciales</small></p>
    </footer>

    <script>
        // Configuration
        const CLUSTER_INFO = {
            1: { name: "Cluster 1 - Bajo Riesgo", color: "#27ae60", icon: "‚úÖ" },
            2: { name: "Cluster 2 - Seguimiento Requerido", color: "#f39c12", icon: "‚ö†Ô∏è" }
        };
        
        const RISK_GROUP_INFO = {
            bajo: { name: "Riesgo Bajo", color: "#27ae60", icon: "üü¢" },
            medio: { name: "Riesgo Medio", color: "#f39c12", icon: "üü°" },
            alto: { name: "Riesgo Alto", color: "#e74c3c", icon: "üî¥" }
        };

        let allPatients = [];

        // Load patients on page load
        document.addEventListener('DOMContentLoaded', loadPatients);

        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPatient();
            }
        });

        async function loadPatients() {
            try {
                const response = await fetch('/api/patients');
                const data = await response.json();
                
                if (data.success) {
                    allPatients = data.patients;
                    displayPatientList(allPatients);
                    updateStats(allPatients);
                } else {
                    throw new Error(data.error || 'Error loading patients');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('patientList').innerHTML = `
                    <div class="no-results">
                        Error al cargar pacientes: ${error.message}
                    </div>
                `;
            }
        }

        function updateStats(patients) {
            document.getElementById('totalPatients').textContent = patients.length;
            document.getElementById('cluster1Count').textContent = patients.filter(p => p.cluster_pred === 1).length;
            document.getElementById('cluster2Count').textContent = patients.filter(p => p.cluster_pred === 2).length;
        }

        function displayPatientList(patients) {
            const container = document.getElementById('patientList');
            
            if (patients.length === 0) {
                container.innerHTML = '<div class="no-results">No se encontraron pacientes</div>';
                return;
            }

            container.innerHTML = patients.slice(0, 20).map(patient => `
                <div class="patient-item" onclick="viewPatient(${patient.index})">
                    <div class="patient-info">
                        <span class="patient-id">Paciente #${patient.index}</span>
                        <span class="patient-details">
                            Edad: ${patient.edad_en_cirugia || 'N/A'} | 
                            FIGO: ${patient.FIGO2023 || 'N/A'} |
                            Riesgo: ${patient.risk_group || 'N/A'}
                        </span>
                    </div>
                    <span class="patient-cluster cluster-${patient.cluster_pred}">
                        ${CLUSTER_INFO[patient.cluster_pred]?.name || 'Cluster ' + patient.cluster_pred}
                    </span>
                </div>
            `).join('');

            if (patients.length > 20) {
                container.innerHTML += `
                    <div class="patient-item" style="justify-content: center; color: var(--text-secondary);">
                        Mostrando 20 de ${patients.length} pacientes. Use la b√∫squeda para encontrar m√°s.
                    </div>
                `;
            }
        }

        function searchPatient() {
            const query = document.getElementById('searchInput').value.trim();
            
            if (!query) {
                displayPatientList(allPatients);
                return;
            }

            // If it's a number, search by exact index
            const indexNum = parseInt(query);
            if (!isNaN(indexNum)) {
                viewPatient(indexNum);
            } else {
                // Filter by partial match
                const filtered = allPatients.filter(p => 
                    String(p.index).includes(query) ||
                    String(p.edad_en_cirugia).includes(query)
                );
                displayPatientList(filtered);
            }
        }

        async function viewPatient(index) {
            try {
                const response = await fetch(`/api/patients/${index}`);
                const data = await response.json();
                
                if (data.success) {
                    displayPatientDetails(data.patient, data.prediction);
                } else {
                    throw new Error(data.error || 'Paciente no encontrado');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }

        function displayPatientDetails(patient, prediction) {
            const resultSection = document.getElementById('resultSection');
            const clusterInfo = CLUSTER_INFO[prediction.cluster_pred] || CLUSTER_INFO[1];
            const riskInfo = RISK_GROUP_INFO[prediction.risk_group] || RISK_GROUP_INFO.medio;

            let html = `
                <div class="result-header">
                    <div class="result-icon">${clusterInfo.icon}</div>
                    <h2>Paciente #${patient.index}</h2>
                    <div class="cluster-badge cluster-${prediction.cluster_pred}" style="background: ${clusterInfo.color}; color: white;">
                        ${clusterInfo.name}
                    </div>
                </div>

                <!-- Patient Data -->
                <h3 style="margin: 2rem 0 1rem; color: var(--primary);">üìã Datos del Paciente</h3>
                <div class="info-grid">
                    <div class="info-card">
                        <h3>üìä Variables Num√©ricas</h3>
                        <ul>
                            <li>Edad en cirug√≠a: ${patient.edad_en_cirugia || 'N/A'}</li>
                            <li>IMC: ${patient.imc || 'N/A'}</li>
                            <li>CA125: ${patient.valor_de_ca125 || 'N/A'}</li>
                            <li>Tama√±o tumoral: ${patient.tamano_tumoral || 'N/A'} cm</li>
                            <li>Rec. Estr√≥geno: ${patient.recep_est_porcent || 'N/A'}%</li>
                            <li>Rec. Progesterona: ${patient.rece_de_Ppor || 'N/A'}%</li>
                        </ul>
                    </div>
                    <div class="info-card">
                        <h3>üî¨ Variables Cl√≠nicas</h3>
                        <ul>
                            <li>ASA: ${patient.asa || 'N/A'}</li>
                            <li>Histolog√≠a: ${patient.histo_defin || 'N/A'}</li>
                            <li>Grado: ${patient.grado_histologi || 'N/A'}</li>
                            <li>FIGO 2023: ${patient.FIGO2023 || 'N/A'}</li>
                            <li>Afect. Linfovascular: ${patient.afectacion_linf || 'N/A'}</li>
                            <li>Met√°stasis: ${patient.metasta_distan || 'N/A'}</li>
                        </ul>
                    </div>
                </div>

                <!-- Survival -->
                <h3 style="margin: 2rem 0 1rem; color: var(--primary);">üìä An√°lisis de Supervivencia</h3>
                <div class="survival-grid">
                    <div class="survival-card">
                        <h4>1 A√±o</h4>
                        <div class="value">${(prediction.S_1y * 100).toFixed(1)}%</div>
                    </div>
                    <div class="survival-card">
                        <h4>3 A√±os</h4>
                        <div class="value">${(prediction.S_3y * 100).toFixed(1)}%</div>
                    </div>
                    <div class="survival-card">
                        <h4>5 A√±os</h4>
                        <div class="value">${(prediction.S_5y * 100).toFixed(1)}%</div>
                    </div>
                    <div class="survival-card">
                        <h4>Grupo de Riesgo</h4>
                        <div class="value" style="font-size: 1.3rem; color: ${riskInfo.color};">
                            ${riskInfo.icon} ${riskInfo.name}
                        </div>
                    </div>
                </div>

                <div class="result-actions">
                    <button class="btn btn-secondary" onclick="backToList()">
                        ‚Üê Volver a la lista
                    </button>
                    <button class="btn btn-primary" onclick="window.print()">
                        üñ®Ô∏è Imprimir
                    </button>
                </div>
            `;

            resultSection.innerHTML = html;
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        function backToList() {
            document.getElementById('resultSection').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
    <script src="js/chatbox.js"></script>
</body>
</html>
